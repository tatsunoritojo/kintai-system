  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

  å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆçµ¦ä¸è‡ªå‹•è¨ˆç®—ï¼‰
  - Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨é€£æºã—ã¦å‹¤å‹™æ™‚é–“ã‚’è‡ªå‹•å–å¾—
  - Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç”Ÿå¾’æƒ…å ±ã‚’åŒæœŸ
  - æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®çµ¦ä¸ã‚’è‡ªå‹•è¨ˆç®—ã™ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 

  æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

  - è¨€èª: Java 17
  - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: Spring Boot 3.2.x
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: PostgreSQL (Docker)
  - èªè¨¼: OAuth 2.0 (Google)
  - ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«: Maven

  ä¸»è¦æ©Ÿèƒ½

  1. Google OAuth 2.0èªè¨¼ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼
  2. è‡ªå‹•åŒæœŸ - Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
  3. å‹•çš„çµ¦ä¸è¨ˆç®— - å‹¤å‹™å½¢æ…‹ã¨ç”Ÿå¾’ã®å­¦æ ¡ç¨®åˆ¥ã«å¿œã˜ãŸå˜ä¾¡ã§è¨ˆç®—
  4. RESTful API - CRUDæ“ä½œã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚½ãƒ¼ãƒˆå¯¾å¿œ
  5. çµ¦ä¸ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ› - JSONå½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

  6ã¤ã®ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«:
  - employees - å¾“æ¥­å“¡æƒ…å ±
  - work_records - å‹¤å‹™è¨˜éŒ²
  - work_types - å‹¤å‹™å½¢æ…‹
  - students - ç”Ÿå¾’æƒ…å ±
  - student_levels - å­¦æ ¡ç¨®åˆ¥
  - hourly_wages - æ™‚çµ¦ãƒã‚¹ã‚¿

  è¨­è¨ˆæ›¸ã¯éå¸¸ã«ã‚ˆãã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚å®Ÿè£…ã«ç€æ‰‹ã™ã‚‹æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã­ã€‚ä½•ã‹ç‰¹å®šã®éƒ¨åˆ†ã«ã¤ã„ã¦è³ª
å•ã‚„ã€å®Ÿè£…ã‚’å§‹ã‚ãŸã„å ´åˆã¯ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚

> è¨­è¨ˆæ›¸ã¸ã®è©•ä¾¡ï¼Œã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™
ã“ã¡ã‚‰ã¯ï¼Œäº‹æ¥­ã«å¿…è¦ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã®ã§ï¼Œå³å¯†ã«è¨­è¨ˆã—ã¾ã™
ã¾ãŸï¼Œç§ã®é–‹ç™ºçµŒé¨“ã¨ã—ã¦ï¼Œãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒè¦‹ã¦ã‚‚ãŠã‹ã—ããªã„ã‚ˆã†ãªæ‰‹é †ã§ä½•ã‚‚ã‹ã‚‚ã‚’
è¡Œã„ãŸã„ã¨è€ƒãˆã¦ã„
ã¾ã™
ãã‚Œã‚‰ã®è¦–ç‚¹ã‚’åŸºã«ï¼Œã‚‚ã†ä¸€åº¦ç´°éƒ¨ã¾ã§èª­ã¿è¾¼ã¿ï¼Œå•é¡Œç‚¹ã‚„æ”¹å–„ç‚¹ï¼Œã‚€ã—ã‚ã‚ˆãè¨­è¨ˆã—ã¦ã„ã‚‹ç‚¹ãªã©ã«ã¤ã„ã¦
ææ¡ˆãƒ™ãƒ¼ã‚¹ã§ã•ã‚‰ãª
ã‚‹è¨­è¨ˆã‚’ã—ã¦ã„ãã¾ã™

â— æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚äº‹æ¥­ç”¨ã®æœ¬ç•ªã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè¦–ç‚¹ã§å¾¹åº•çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¾ã™ã€‚

â— ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè¦³ç‚¹ã‹ã‚‰ã€å¾¹åº•çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ä»¥ä¸‹ã€è©³ç´°ãªåˆ†æçµæœã‚’ãŠä¼ãˆã—ã¾ã™ã€‚

  ---
  è¨­è¨ˆæ›¸ç·åˆãƒ¬ãƒ“ãƒ¥ãƒ¼å ±å‘Šæ›¸

  ğŸ“‹ 1. è¦ä»¶å®šç¾©æ›¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼

  âœ… å„ªã‚Œã¦ã„ã‚‹ç‚¹

  1. ã‚¹ã‚³ãƒ¼ãƒ—ã®æ˜ç¢ºåŒ–: In-Scope/Out-of-ScopeãŒæ˜ç¤ºã•ã‚Œã€ãƒ•ã‚§ãƒ¼ã‚ºåˆ†ã‘ã‚‚é©åˆ‡
  2. è¦ä»¶ã®IDç®¡ç†: FR/NFRã«è­˜åˆ¥å­ãŒä»˜ä¸ã•ã‚Œã€ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹
  3. æ®µéšçš„ãªæ‹¡å¼µè¨ˆç”»: ãƒ•ã‚§ãƒ¼ã‚º2ä»¥é™ã®å±•æœ›ãŒç¤ºã•ã‚Œã¦ã„ã‚‹

  âš ï¸ é‡å¤§ãªæ¬ è½äº‹é …

  1.1. ãƒ‡ãƒ¼ã‚¿ç®¡ç†è¦ä»¶ã®ä¸è¶³

  ã€è¿½åŠ ã™ã¹ãè¦ä»¶ã€‘
  - ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ãƒãƒªã‚·ãƒ¼ï¼ˆçµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã¯ä½•å¹´ä¿ç®¡ï¼Ÿï¼‰
  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚«ãƒãƒªè¦ä»¶ï¼ˆRPO/RTOï¼‰
  - ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒãƒªã‚·ãƒ¼ï¼ˆé€€è·è€…ã€å’æ¥­ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ï¼‰
  - å€‹äººæƒ…å ±ä¿è­·å¯¾å¿œï¼ˆGDPRã€å€‹äººæƒ…å ±ä¿è­·æ³•ã¸ã®æº–æ‹ ï¼‰

  1.2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®ä¸è¶³

  ã€è¿½åŠ ã™ã¹ãè¦ä»¶ã€‘
  NFR-005: ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    - ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰ã®å®Ÿè£…
    - ç®¡ç†è€…/ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™åˆ†é›¢

  NFR-006: ç›£æŸ»ãƒ­ã‚°
    - ã™ã¹ã¦ã®çµ¦ä¸è¨ˆç®—ã€ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ“ä½œã®ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    - ãƒ­ã‚°ã®æ”¹ã–ã‚“é˜²æ­¢ã€æœ€ä½5å¹´é–“ã®ä¿ç®¡

  NFR-007: ãƒ‡ãƒ¼ã‚¿ä¿è­·
    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æš—å·åŒ–ï¼ˆat restï¼‰
    - å€‹äººæƒ…å ±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æš—å·åŒ–
    - ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã®å®‰å…¨ãªä¿ç®¡ï¼ˆVaultç­‰ï¼‰

  1.3. å¯ç”¨æ€§ãƒ»ä¿¡é ¼æ€§è¦ä»¶ã®ä¸è¶³

  ã€è¿½åŠ ã™ã¹ãè¦ä»¶ã€‘
  NFR-008: å¯ç”¨æ€§
    - ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç‡ç›®æ¨™ï¼ˆä¾‹: 99.5%ï¼‰
    - è¨ˆç”»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã®å®šç¾©

  NFR-009: éšœå®³å¯¾å¿œ
    - Google APIéšœå®³æ™‚ã®æŒ™å‹•ï¼ˆãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ï¼‰
    - éƒ¨åˆ†çš„ãªéšœå®³æ™‚ã®ç¸®é€€é‹è»¢

  NFR-010: åŒæ™‚å®Ÿè¡Œæ€§
    - åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã®ä¸Šé™
    - APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™

  1.4. é‹ç”¨è¦ä»¶ã®ä¸è¶³

  ã€è¿½åŠ ã™ã¹ãè¦ä»¶ã€‘
  NFR-011: ç›£è¦–ãƒ»é€šçŸ¥
    - ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¦ä»¶
    - ç•°å¸¸æ¤œçŸ¥æ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥
    - ãƒãƒƒãƒå‡¦ç†å¤±æ•—æ™‚ã®é€šçŸ¥

  NFR-012: ãƒ­ã‚°ç®¡ç†
    - ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®å®šç¾©ï¼ˆERROR/WARN/INFO/DEBUGï¼‰
    - ãƒ­ã‚°ä¿æŒæœŸé–“
    - å€‹äººæƒ…å ±ã®ãƒã‚¹ã‚­ãƒ³ã‚°è¦ä»¶

  ğŸ” æ›–æ˜§ãªè¡¨ç¾ã®æ˜ç¢ºåŒ–ãŒå¿…è¦

  | ç®‡æ‰€                              | å•é¡Œç‚¹                       | æ”¹å–„æ¡ˆ
            |
  |-----------------------------------|------------------------------|-----------------------------
------------|
  | FR-002: "å®šæœŸçš„ï¼ˆä¾‹:1æ™‚é–“ã«1å›ï¼‰" | æœ¬ç•ªç’°å¢ƒã§ã®å®Ÿè¡Œé »åº¦ãŒæœªç¢ºå®š |
ã€Œæ¯æ™‚0åˆ†ã«å®Ÿè¡Œã€ãªã©å…·ä½“çš„ã«å®šç¾©       |
  | FR-004: "æœ€å¤§æ‹˜æŸ6æ™‚é–“"           | è¶…éæ™‚ã®å‡¦ç†ãŒä¸æ˜           |
è¶…éæ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€è­¦å‘Šå‡ºåŠ›ã‚’å®šç¾©  |
  | FR-002: "é‡è¤‡ç™»éŒ²ã¯é˜²æ­¢ã™ã‚‹"      | åˆ¤å®šåŸºæº–ãŒæ›–æ˜§               |
google_event_idã«ã‚ˆã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’æ˜ç¤º |

  ---
  ğŸ—ï¸ 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼

  âœ… å„ªã‚Œã¦ã„ã‚‹ç‚¹

  1. ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢: APIå±¤ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®åˆ†é›¢ãŒæ˜ç¢º
  2. å›³ã®æ´»ç”¨: Mermaidã«ã‚ˆã‚‹è¦–è¦šåŒ–ã§ç†è§£ã—ã‚„ã™ã„
  3. æŠ€è¡“é¸å®šã®å¦¥å½“æ€§: Spring Bootã€PostgreSQLã¯å®Ÿç¸¾ãŒã‚ã‚Šé©åˆ‡

  âš ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸Šã®é‡å¤§ãªæ¬ è½

  2.1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®è©³ç´°ä¸è¶³

  ç¾åœ¨ã®ERå›³ã«ä¸è¶³ã—ã¦ã„ã‚‹ã‚‚ã®:

  -- employees ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã¹ãã‚«ãƒ©ãƒ 
  ALTER TABLE employees ADD COLUMN (
    role VARCHAR(20) NOT NULL DEFAULT 'USER',  -- 'ADMIN', 'USER'
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    google_refresh_token TEXT,  -- æš—å·åŒ–ã—ã¦ä¿å­˜
    last_synced_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  );

  -- work_records ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã¹ãã‚«ãƒ©ãƒ 
  ALTER TABLE work_records ADD COLUMN (
    work_type_id INTEGER REFERENCES work_types(id),  -- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¨è«–ã ã‘ã§ãªãæ˜ç¤ºçš„ã«ä¿å­˜
    student_id INTEGER REFERENCES students(id),  -- åå‰æŠ½å‡ºã ã‘ã§ãªãIDã§é–¢é€£ä»˜ã‘
    extracted_student_name TEXT,  -- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æŠ½å‡ºã—ãŸç”Ÿå¾’åï¼ˆå‚è€ƒç”¨ï¼‰
    calculated_minutes INTEGER,  -- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦å†è¨ˆç®—ã‚’é¿ã‘ã‚‹
    is_paid BOOLEAN NOT NULL DEFAULT FALSE,  -- çµ¦ä¸æ”¯æ‰•æ¸ˆã¿ãƒ•ãƒ©ã‚°
    notes TEXT,
    synced_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  );

  -- ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç›£æŸ»ç”¨ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
  ALTER TABLE <table_name> ADD COLUMN (
    created_by INTEGER REFERENCES employees(id),
    updated_by INTEGER REFERENCES employees(id)
  );

  å¿…é ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
  CREATE INDEX idx_work_records_employee_time ON work_records(employee_id, start_time);
  CREATE INDEX idx_work_records_google_event ON work_records(google_event_id);
  CREATE INDEX idx_work_records_payment ON work_records(employee_id, is_paid);
  CREATE UNIQUE INDEX idx_students_name ON students(name);
  CREATE INDEX idx_hourly_wages_lookup ON hourly_wages(work_type_id, student_level_id);

  åˆ¶ç´„ã®æ˜ç¤º:
  ALTER TABLE work_records ADD CONSTRAINT chk_time_range
    CHECK (start_time < end_time);

  ALTER TABLE hourly_wages ADD CONSTRAINT chk_positive_wage
    CHECK (wage > 0);

  2.2. æ¬ è½ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

  è¿½åŠ ã™ã¹ãã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¦ç´ :

  graph TD
      subgraph "è¿½åŠ ã™ã¹ãå±¤"
          Cache[Redis Cache Layer]
          Queue[Message Queue - RabbitMQ/SQS]
          Monitor[Monitoring - Prometheus/Grafana]
          Logger[Centralized Logging - ELK]
      end

      API --> Cache
      BatchJobs --> Queue
      All[All Components] --> Monitor
      All --> Logger

  ç†ç”±:
  - Redis: é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å˜ä¾¡ãƒã‚¹ã‚¿ã€å¾“æ¥­å“¡æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  - Message Queue: ãƒãƒƒãƒå‡¦ç†ã®éåŒæœŸåŒ–ã€ãƒªãƒˆãƒ©ã‚¤åˆ¶å¾¡
  - Monitoring: æœ¬ç•ªé‹ç”¨ã«å¿…é ˆã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
  - Centralized Logging: åˆ†æ•£ãƒ­ã‚°ã®é›†ç´„ã€æ¤œç´¢

  2.3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è©³ç´°åŒ–

  ç¾çŠ¶ã®å•é¡Œç‚¹:
  - JWTã®ä¿å­˜å ´æ‰€ã€æœ‰åŠ¹æœŸé™ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆ¦ç•¥ãŒæœªå®šç¾©
  - ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰ã®ä»•çµ„ã¿ãŒãªã„
  - CORSã€CSRFã®å¯¾ç­–ãŒæœªè¨˜è¼‰

  æ¨å¥¨è¨­è¨ˆ:
  JWTè¨­è¨ˆ:
    ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³:
      æœ‰åŠ¹æœŸé™: 15åˆ†
      ä¿å­˜å ´æ‰€: ãƒ¡ãƒ¢ãƒªã®ã¿ï¼ˆLocalStorageä¸å¯ï¼‰
    ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³:
      æœ‰åŠ¹æœŸé™: 7æ—¥
      ä¿å­˜å ´æ‰€: HttpOnly Cookie (Secure, SameSite=Strict)
      ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: ä½¿ç”¨ã”ã¨ã«æ–°è¦ç™ºè¡Œ
    å¤±åŠ¹ç®¡ç†:
      æ–¹å¼: Redisã«ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆä¿å­˜
      TTL: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã¾ã§

  Google OAuth ãƒˆãƒ¼ã‚¯ãƒ³:
    ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³:
      ä¿å­˜: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆæš—å·åŒ–å¿…é ˆï¼‰
      æš—å·åŒ–æ–¹å¼: AES-256-GCM
      éµç®¡ç†: AWS KMS / HashiCorp Vault

  ---
  ğŸ“ 3. è©³ç´°è¨­è¨ˆæ›¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼

  âš ï¸ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆã®ä¸è¶³

  3.1. æ¬ è½ã—ã¦ã„ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

  // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»ç›£è¦–ç”¨
  GET /health              // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ­»æ´»ç›£è¦–
  GET /health/ready        // Kubernetes readiness probeç”¨
  GET /health/live         // Kubernetes liveness probeç”¨
  GET /metrics             // Prometheus metrics

  // èªè¨¼é–¢é€£
  POST /api/v1/auth/login          // OAuthé–‹å§‹
  POST /api/v1/auth/callback       // OAuth callback
  POST /api/v1/auth/refresh        // ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
  POST /api/v1/auth/logout         // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

  // ä¸è¶³ã—ã¦ã„ã‚‹CRUDæ“ä½œ
  PUT  /api/v1/employees/{id}      // æ›´æ–°
  DELETE /api/v1/employees/{id}    // å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤æ¨å¥¨ï¼‰

  // ãƒãƒ«ã‚¯æ“ä½œ
  POST /api/v1/employees/bulk      // ä¸€æ‹¬ç™»éŒ²
  DELETE /api/v1/employees/bulk    // ä¸€æ‹¬å‰Šé™¤

  // ç®¡ç†è€…ç”¨
  GET /api/v1/admin/sync-status    // åŒæœŸçŠ¶æ…‹ç¢ºèª
  GET /api/v1/admin/audit-logs     // ç›£æŸ»ãƒ­ã‚°å–å¾—

  3.2. APIè¨­è¨ˆã®æ”¹å–„ææ¡ˆ

  ç¾åœ¨ã®PayrollDtoã®å•é¡Œç‚¹:
  {
    "totalPayment": 216000  // å˜ä½ãŒä¸æ˜ã€é€šè²¨ã‚‚ä¸æ˜
  }

  æ”¹å–„ç‰ˆ:
  {
    "employee": {
      "id": 1,
      "name": "Taro Yamada",
      "email": "taro@example.com"
    },
    "period": {
      "start": "2025-11-01",
      "end": "2025-11-30"
    },
    "summary": {
      "totalWorkMinutes": 5400,
      "totalWorkHours": 90.0,
      "totalPayment": {
        "amount": 216000,
        "currency": "JPY"
      },
      "calculatedAt": "2025-12-01T10:00:00Z",
      "calculatedBy": "admin@example.com"
    },
    "paymentDetails": [
      {
        "workTypeName": "å€‹åˆ¥æŒ‡å°",
        "studentLevelName": "ä¸­å­¦ç”Ÿ",
        "recordCount": 12,
        "totalMinutes": 3600,
        "totalHours": 60.0,
        "appliedWage": {
          "amount": 3000,
          "currency": "JPY",
          "unit": "HOUR"
        },
        "subtotal": {
          "amount": 180000,
          "currency": "JPY"
        }
      }
    ],
    "warnings": [  // ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ãŒæ³¨æ„ã™ã¹ãäº‹é …
      {
        "code": "STUDENT_NOT_FOUND",
        "message": "ç”Ÿå¾’ã€ŒBã€ãŒãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ãªã„ãŸã‚ã€è©²å½“è¨˜éŒ²ã¯è¨ˆç®—ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã—ãŸ",
        "affectedRecordIds": [123, 456]
      }
    ],
    "errors": []  // è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã“ã“ã«è¨˜è¼‰
  }

  3.3. ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¨™æº–åŒ–

  ç¾åœ¨ã®è¨­è¨ˆ:
  {
    "timestamp": "2025-12-29T10:00:00.000+00:00",
    "status": 400,
    "error": "Bad Request",
    "message": "Employee ID not found"
  }

  æ”¹å–„ç‰ˆï¼ˆRFC 7807æº–æ‹ ï¼‰:
  {
    "type": "https://api.example.com/errors/employee-not-found",
    "title": "Employee Not Found",
    "status": 404,
    "detail": "Employee with ID 999 does not exist in the system",
    "instance": "/api/v1/employees/999",
    "timestamp": "2025-12-29T10:00:00Z",
    "traceId": "abc123xyz",  // åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ç”¨
    "errors": [  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚
      {
        "field": "email",
        "code": "INVALID_FORMAT",
        "message": "Email format is invalid"
      }
    ]
  }

  ---
  ğŸ”’ 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦³ç‚¹ã§ã®åŒ…æ‹¬çš„ãƒ¬ãƒ“ãƒ¥ãƒ¼

  âš ï¸ OWASP Top 10 å¯¾ç­–çŠ¶æ³

  | è„…å¨                        | ç¾çŠ¶                        | å¯¾ç­–å¿…è¦æ€§  |
  |-----------------------------|-----------------------------|-------------|
  | Broken Access Control       | âŒ RBACæœªå®šç¾©               | ğŸ”´ Critical |
  | Cryptographic Failures      | âŒ ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜æ–¹æ³•æœªå®šç¾©   | ğŸ”´ Critical |
  | Injection                   | â–³ JPAä½¿ç”¨ã§ä¸€å®šã®å¯¾ç­–       | ğŸŸ¡ è¦ç¢ºèª   |
  | Insecure Design             | â–³ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—            | ğŸŸ¡ Medium   |
  | Security Misconfiguration   | âŒ è¨­å®šæŒ‡é‡ãªã—             | ğŸŸ¡ Medium   |
  | Vulnerable Components       | â–³ ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†æœªè¨˜è¼‰  | ğŸŸ¡ Medium   |
  | Authentication Failures     | âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿæ§‹ãªã—       | ğŸ”´ Critical |
  | Software and Data Integrity | âŒ ç›£æŸ»ãƒ­ã‚°ãªã—             | ğŸŸ¡ Medium   |
  | Logging Failures            | âŒ ãƒ­ã‚°æˆ¦ç•¥æœªå®šç¾©           | ğŸŸ¡ Medium   |
  | SSRF                        | âœ… Google APIã®ã¿ã§ä½ãƒªã‚¹ã‚¯ | ğŸŸ¢ Low      |

  ğŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®è¿½åŠ ææ¡ˆ

  ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶è©³ç´°

  ### SEC-001: èªè¨¼ãƒ»èªå¯
  - Spring Security 6 ã‚’ä½¿ç”¨
  - OAuth 2.0 Authorization Code Flow with PKCE
  - JWTç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : RS256ï¼ˆHS256ä¸å¯ï¼‰
  - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ

  ### SEC-002: ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
  - @PreAuthorize ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡
  - ADMIN: ã™ã¹ã¦ã®æ“ä½œå¯èƒ½
  - USER: è‡ªåˆ†ã®çµ¦ä¸æƒ…å ±ã®ã¿é–²è¦§å¯èƒ½

  ### SEC-003: ãƒ‡ãƒ¼ã‚¿ä¿è­·
  - DBæ¥ç¶šã¯TLSå¿…é ˆ
  - å€‹äººæƒ…å ±ã‚«ãƒ©ãƒ ï¼ˆemailç­‰ï¼‰ã¯æš—å·åŒ–
  - Google refresh_token ã¯ AES-256-GCM ã§æš—å·åŒ–

  ### SEC-004: å…¥åŠ›æ¤œè¨¼
  - ã™ã¹ã¦ã®DTOã« @Valid é©ç”¨
  - @Email, @NotNull, @Size ãªã©ã®Bean Validationä½¿ç”¨
  - ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿ã§æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼

  ### SEC-005: ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  - Bucket4j ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨
  - èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: 100req/min
  - æœªèªè¨¼: 10req/min

  ### SEC-006: ç›£æŸ»ãƒ­ã‚°
  - Spring Data JPA Auditing ä½¿ç”¨
  - è¨˜éŒ²å¯¾è±¡: ä½œæˆè€…ã€æ›´æ–°è€…ã€ä½œæˆæ—¥æ™‚ã€æ›´æ–°æ—¥æ™‚
  - çµ¦ä¸è¨ˆç®—å®Ÿè¡Œãƒ­ã‚°ï¼ˆèª°ãŒã€ã„ã¤ã€èª°ã®çµ¦ä¸ã‚’è¨ˆç®—ã—ãŸã‹ï¼‰

  ---
  ğŸ§ª 5. æ¬ è½ã—ã¦ã„ã‚‹è¨­è¨ˆè¦ç´ 

â— 5.1. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ï¼ˆå®Œå…¨ã«æ¬ è½ï¼‰

  è¿½åŠ ã™ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: TEST_STRATEGY.md

  # ãƒ†ã‚¹ãƒˆæˆ¦ç•¥æ›¸

  ## ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«

  ### å˜ä½“ãƒ†ã‚¹ãƒˆ (Unit Test)
  - **ãƒ„ãƒ¼ãƒ«**: JUnit 5, Mockito, AssertJ
  - **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: 80%ä»¥ä¸Šï¼ˆJaCoCoï¼‰
  - **å¯¾è±¡**: ã™ã¹ã¦ã®Service, Repository, Util ã‚¯ãƒ©ã‚¹
  - **ä¾‹**:
    ```java
    @Test
    void calculatePayroll_æ­£å¸¸ç³»_å‹•çš„å˜ä¾¡é©ç”¨() {
        // Given
        Employee employee = createTestEmployee();
        List<WorkRecord> records = createTestWorkRecords();

        // When
        PayrollDto result = payrollService.calculatePayroll(
            employee.getId(),
            LocalDate.of(2025, 11, 1),
            LocalDate.of(2025, 11, 30)
        );

        // Then
        assertThat(result.getTotalPayment().getAmount())
            .isEqualTo(216000);
    }

  çµ±åˆãƒ†ã‚¹ãƒˆ (Integration Test)

  - ãƒ„ãƒ¼ãƒ«: Spring Boot Test, Testcontainers (PostgreSQL)
  - å¯¾è±¡: APIå±¤ + DBå±¤ã®çµåˆ
  - ä¾‹: REST APIã®å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ

  E2Eãƒ†ã‚¹ãƒˆ

  - ãƒ„ãƒ¼ãƒ«: REST Assured
  - å¯¾è±¡: å®Ÿéš›ã®Google APIé€£æºï¼ˆãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½¿ç”¨ï¼‰
  - ã‚·ãƒŠãƒªã‚ªä¾‹:
    a. ãƒ­ã‚°ã‚¤ãƒ³ â†’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ â†’ çµ¦ä¸è¨ˆç®— â†’ ãƒ¬ãƒãƒ¼ãƒˆå–å¾—

  æ€§èƒ½ãƒ†ã‚¹ãƒˆ

  - ãƒ„ãƒ¼ãƒ«: JMeter / Gatling
  - ç›®æ¨™: å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  500msä»¥å†…ï¼ˆNFR-002ï¼‰
  - ã‚·ãƒŠãƒªã‚ª:
    - 100åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€çµ¦ä¸è¨ˆç®—APIå‘¼ã³å‡ºã—
    - ãƒãƒƒãƒå‡¦ç†ã®å®Ÿè¡Œæ™‚é–“æ¸¬å®š

  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

  - ãƒ„ãƒ¼ãƒ«: OWASP ZAP, SonarQube
  - å¯¾è±¡:
    - SQL Injection
    - XSS
    - èªè¨¼ãƒã‚¤ãƒ‘ã‚¹
    - æ¨©é™æ˜‡æ ¼

  ---

  ### 5.2. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»é‹ç”¨æˆ¦ç•¥ï¼ˆå®Œå…¨ã«æ¬ è½ï¼‰

  **è¿½åŠ ã™ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: `DEPLOYMENT.md`**

  ```markdown
  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥

  ## ç’°å¢ƒæ§‹æˆ

  | ç’°å¢ƒ | ç”¨é€” | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | å¤–éƒ¨API |
  |------|------|-------------|---------|
  | local | é–‹ç™ºè€…ãƒ­ãƒ¼ã‚«ãƒ« | H2 in-memory | ãƒ¢ãƒƒã‚¯ |
  | dev | é–‹ç™ºçµ±åˆç’°å¢ƒ | PostgreSQL (Docker) | ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |
  | staging | æœ¬ç•ªå‰æ¤œè¨¼ | PostgreSQL (åŒæ§‹æˆ) | ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |
  | production | æœ¬ç•ª | PostgreSQL (HAæ§‹æˆ) | æœ¬ç•ªã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |

  ## CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

  ```yaml
  # GitHub Actionsä¾‹
  name: CI/CD Pipeline

  on:
    push:
      branches: [main, develop]
    pull_request:
      branches: [main]

  jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Set up JDK 17
          uses: actions/setup-java@v3
        - name: Run tests
          run: mvn clean verify
        - name: Upload coverage
          uses: codecov/codecov-action@v3

    security-scan:
      runs-on: ubuntu-latest
      steps:
        - name: Run OWASP Dependency Check
          run: mvn dependency-check:check
        - name: SonarQube Scan
          run: mvn sonar:sonar

    build-and-deploy:
      needs: [test, security-scan]
      if: github.ref == 'refs/heads/main'
      steps:
        - name: Build Docker image
          run: docker build -t attendance-api:${{ github.sha }} .
        - name: Push to registry
          run: docker push attendance-api:${{ github.sha }}
        - name: Deploy to staging
          run: kubectl apply -f k8s/staging/

  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

  ãƒ„ãƒ¼ãƒ«: Flyway

  -- V1__initial_schema.sql
  CREATE TABLE employees (
      id SERIAL PRIMARY KEY,
      email VARCHAR(255) UNIQUE NOT NULL,
      name VARCHAR(255) NOT NULL,
      role VARCHAR(20) NOT NULL DEFAULT 'USER',
      is_active BOOLEAN NOT NULL DEFAULT TRUE,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  );

  -- V2__add_audit_columns.sql
  ALTER TABLE employees ADD COLUMN created_by INTEGER REFERENCES employees(id);
  ALTER TABLE employees ADD COLUMN updated_by INTEGER REFERENCES employees(id);

  ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥:
  - ã™ã¹ã¦ã®ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã¯Flywayã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç®¡ç†
  - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®Undoã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚ä½œæˆ
  - æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«stagingã§æ¤œè¨¼

  ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

  ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†: Prometheus + Grafana

  // Spring Boot Actuatorè¨­å®š
  management:
    endpoints:
      web:
        exposure:
          include: health,info,metrics,prometheus
    metrics:
      tags:
        application: attendance-management

  ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šä¾‹:
  # Prometheus Alert Rules
  groups:
    - name: attendance-api
      rules:
        - alert: HighErrorRate
          expr: rate(http_server_requests_seconds_count{status=~"5.."}[5m]) > 0.05
          for: 5m
          annotations:
            summary: "High error rate detected"

        - alert: CalendarSyncFailed
          expr: calendar_sync_failures_total > 3
          for: 10m
          annotations:
            summary: "Calendar sync job failing repeatedly"

  ---

  ### 5.3. ãƒ­ã‚°æˆ¦ç•¥ï¼ˆå®Œå…¨ã«æ¬ è½ï¼‰

  **è¿½åŠ ã™ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: `LOGGING.md`**

  ```markdown
  # ãƒ­ã‚°æˆ¦ç•¥

  ## ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«å®šç¾©

  | ãƒ¬ãƒ™ãƒ« | ç”¨é€” | ä¾‹ |
  |--------|------|-----|
  | ERROR | å³æ™‚å¯¾å¿œãŒå¿…è¦ãªã‚¨ãƒ©ãƒ¼ | DBæ¥ç¶šå¤±æ•—ã€Google APIèªè¨¼ã‚¨ãƒ©ãƒ¼ |
  | WARN | æ³¨æ„ãŒå¿…è¦ã ãŒå‡¦ç†ã¯ç¶™ç¶š | ç”Ÿå¾’ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ãªã„ç”Ÿå¾’åã€ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ |
  | INFO | é‡è¦ãªæ¥­å‹™ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€çµ¦ä¸è¨ˆç®—å®Ÿè¡Œã€ãƒãƒƒãƒé–‹å§‹/çµ‚äº† |
  | DEBUG | ãƒ‡ãƒãƒƒã‚°æƒ…å ± | SQLã‚¯ã‚¨ãƒªã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´° |

  ## æ§‹é€ åŒ–ãƒ­ã‚°ï¼ˆJSONå½¢å¼ï¼‰

  ```json
  {
    "timestamp": "2025-12-29T10:00:00.123Z",
    "level": "INFO",
    "logger": "com.example.attendance.service.PayrollService",
    "thread": "http-nio-8080-exec-1",
    "message": "Payroll calculation completed",
    "context": {
      "employeeId": 1,
      "startDate": "2025-11-01",
      "endDate": "2025-11-30",
      "totalPayment": 216000,
      "executionTimeMs": 234
    },
    "traceId": "abc123xyz",
    "spanId": "def456uvw",
    "userId": "admin@example.com"
  }

  å€‹äººæƒ…å ±ã®ãƒã‚¹ã‚­ãƒ³ã‚°

  @Component
  public class SensitiveDataMasker {
      public String maskEmail(String email) {
          // user@example.com â†’ u***@example.com
          return email.replaceAll("(?<=.{1}).(?=.*@)", "*");
      }

      public String maskName(String name) {
          // å±±ç”°å¤ªéƒ â†’ å±±ç”°**
          return name.substring(0, 2) + "*".repeat(name.length() - 2);
      }
  }

  ãƒ­ã‚°ä¿æŒæœŸé–“

  | ç’°å¢ƒ       | ä¿æŒæœŸé–“                 | ä¿å­˜å…ˆ          |
  |------------|--------------------------|-----------------|
  | local      | 1æ—¥                      | ã‚³ãƒ³ãƒ†ãƒŠå†…      |
  | dev        | 7æ—¥                      | CloudWatch Logs |
  | staging    | 30æ—¥                     | CloudWatch Logs |
  | production | 90æ—¥ï¼ˆHOTï¼‰+ 5å¹´ï¼ˆCOLDï¼‰ | S3 Glacier      |


  ---

  ### 5.4. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆè©³ç´°ãŒä¸è¶³ï¼‰

  **è¿½åŠ ã™ã¹ãè¨­è¨ˆ:**

  ```java
  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®æ˜ç¤º
  @Service
  @Transactional(readOnly = true)  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯èª­ã¿å–ã‚Šå°‚ç”¨
  public class PayrollService {

      @Transactional  // æ›¸ãè¾¼ã¿ãŒå¿…è¦ãªå ´åˆã®ã¿ä¸Šæ›¸ã
      public PayrollDto calculateAndSavePayroll(Integer employeeId,
                                                 LocalDate start,
                                                 LocalDate end) {
          // 1. çµ¦ä¸è¨ˆç®—
          PayrollDto payroll = calculatePayroll(employeeId, start, end);

          // 2. è¨ˆç®—å±¥æ­´ã‚’ä¿å­˜ï¼ˆç›£æŸ»ç”¨ï¼‰
          PayrollHistory history = new PayrollHistory();
          history.setEmployeeId(employeeId);
          history.setCalculatedAt(Instant.now());
          history.setTotalPayment(payroll.getTotalPayment());
          payrollHistoryRepository.save(history);

          // 3. è©²å½“ã™ã‚‹ work_records ã‚’ "æ”¯æ‰•æ¸ˆã¿" ã«ãƒãƒ¼ã‚¯
          workRecordRepository.markAsPaid(employeeId, start, end);

          return payroll;
      }
  }

  // ä¸¦è¡Œåˆ¶å¾¡ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰
  @Entity
  public class Employee {
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      private Integer id;

      @Version  // æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ç”¨
      private Integer version;

      // ...
  }

  // æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆ
  @Lock(LockModeType.PESSIMISTIC_WRITE)
  @Query("SELECT e FROM Employee e WHERE e.id = :id")
  Optional<Employee> findByIdWithLock(@Param("id") Integer id);

  ---
  5.5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥ï¼ˆè©³ç´°ãŒä¸è¶³ï¼‰

  ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©:

  @RestControllerAdvice
  public class GlobalExceptionHandler {

      @ExceptionHandler(EmployeeNotFoundException.class)
      public ResponseEntity<ErrorResponse> handleEmployeeNotFound(
              EmployeeNotFoundException ex,
              HttpServletRequest request) {

          ErrorResponse error = ErrorResponse.builder()
              .type("https://api.example.com/errors/employee-not-found")
              .title("Employee Not Found")
              .status(404)
              .detail(ex.getMessage())
              .instance(request.getRequestURI())
              .timestamp(Instant.now())
              .traceId(MDC.get("traceId"))
              .build();

          return ResponseEntity.status(404).body(error);
      }

      @ExceptionHandler(GoogleApiException.class)
      public ResponseEntity<ErrorResponse> handleGoogleApiError(
              GoogleApiException ex) {

          // Google APIéšœå®³æ™‚ã¯503ã‚’è¿”ã™
          ErrorResponse error = ErrorResponse.builder()
              .type("https://api.example.com/errors/external-service-unavailable")
              .title("External Service Unavailable")
              .status(503)
              .detail("Google Calendar API is temporarily unavailable")
              .retryAfter(300)  // 5åˆ†å¾Œã«å†è©¦è¡Œ
              .build();

          return ResponseEntity.status(503)
              .header("Retry-After", "300")
              .body(error);
      }

      @ExceptionHandler(MethodArgumentNotValidException.class)
      public ResponseEntity<ErrorResponse> handleValidationError(
              MethodArgumentNotValidException ex) {

          List<FieldError> fieldErrors = ex.getBindingResult()
              .getFieldErrors()
              .stream()
              .map(fe -> new FieldError(
                  fe.getField(),
                  fe.getCode(),
                  fe.getDefaultMessage()
              ))
              .toList();

          ErrorResponse error = ErrorResponse.builder()
              .type("https://api.example.com/errors/validation-failed")
              .title("Validation Failed")
              .status(400)
              .detail("Input validation failed")
              .errors(fieldErrors)
              .build();

          return ResponseEntity.status(400).body(error);
      }
  }

  ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥:

  @Service
  public class CalendarSyncService {

      @Retryable(
          value = {GoogleApiException.class},
          maxAttempts = 3,
          backoff = @Backoff(
              delay = 1000,
              multiplier = 2,
              maxDelay = 10000
          )
      )
      public void syncCalendar(Employee employee) {
          // Google Calendar APIå‘¼ã³å‡ºã—
          // å¤±æ•—æ™‚ã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
      }

      @Recover
      public void recover(GoogleApiException ex, Employee employee) {
          // 3å›ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚å¤±æ•—ã—ãŸå ´åˆ
          log.error("Calendar sync failed after retries for employee: {}",
                    employee.getId(), ex);

          // ç®¡ç†è€…ã«ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
          alertService.sendAlert(
              "Calendar sync failed for employee: " + employee.getName()
          );

          // Dead Letter Queue ã«ä¿å­˜ï¼ˆå¾Œã§æ‰‹å‹•ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã«ã™ã‚‹ï¼‰
          dlqRepository.save(new FailedSyncJob(employee.getId(), ex.getMessage()));
      }
  }

  ---
  ğŸ“Š 6. ãƒãƒƒãƒå‡¦ç†ã®è©³ç´°è¨­è¨ˆï¼ˆä¸è¶³ï¼‰

  6.1. CalendarSyncJob ã®è©³ç´°è¨­è¨ˆ

  ç¾åœ¨ã®å•é¡Œç‚¹:
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒä¸æ˜ç¢º
  - å®Ÿè¡Œæ™‚é–“ãŒé•·ããªã£ãŸå ´åˆã®å¯¾å¿œãŒæœªå®šç¾©
  - éƒ¨åˆ†çš„ãªå¤±æ•—æ™‚ã®æŒ™å‹•ãŒæœªå®šç¾©

  æ”¹å–„ææ¡ˆ:

  @Component
  @Slf4j
  public class CalendarSyncJob {

      @Scheduled(cron = "0 0 * * * *")  // æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ
      @SchedulerLock(
          name = "CalendarSyncJob",
          lockAtMostFor = "50m",  // æœ€å¤§50åˆ†ã§ãƒ­ãƒƒã‚¯è§£æ”¾
          lockAtLeastFor = "5m"   // æœ€ä½5åˆ†ã¯ãƒ­ãƒƒã‚¯ä¿æŒ
      )
      public void execute() {
          log.info("Calendar sync job started");

          Instant startTime = Instant.now();
          int successCount = 0;
          int failureCount = 0;
          List<SyncError> errors = new ArrayList<>();

          try {
              List<Employee> activeEmployees = employeeRepository
                  .findByIsActiveTrue();

              for (Employee employee : activeEmployees) {
                  try {
                      syncEmployeeCalendar(employee);
                      successCount++;
                  } catch (Exception ex) {
                      failureCount++;
                      errors.add(new SyncError(employee.getId(), ex.getMessage()));
                      log.error("Failed to sync calendar for employee: {}",
                                employee.getId(), ex);
                  }
              }
          } finally {
              Duration duration = Duration.between(startTime, Instant.now());

              // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²
              meterRegistry.counter("calendar_sync.success").increment(successCount);
              meterRegistry.counter("calendar_sync.failure").increment(failureCount);
              meterRegistry.timer("calendar_sync.duration").record(duration);

              log.info("Calendar sync job completed. Success: {}, Failure: {}, Duration: {}",
                       successCount, failureCount, duration);

              // å¤±æ•—ãŒå¤šã„å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆ
              if (failureCount > activeEmployees.size() * 0.1) {  // 10%ä»¥ä¸Šå¤±æ•—
                  alertService.sendAlert(
                      "Calendar sync job has high failure rate: " + failureCount
                  );
              }
          }
      }

      private void syncEmployeeCalendar(Employee employee) {
          // æœ€å¾Œã®åŒæœŸæ™‚åˆ»ä»¥é™ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿å–å¾—
          Instant lastSync = employee.getLastSyncedAt() != null
              ? employee.getLastSyncedAt()
              : Instant.now().minus(30, ChronoUnit.DAYS);

          List<Event> events = googleCalendarService.getEvents(
              employee,
              lastSync,
              Instant.now()
          );

          int newRecords = 0;
          int duplicates = 0;

          for (Event event : events) {
              // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
              Optional<WorkType> workType = matchWorkType(event.getSummary());
              if (workType.isEmpty() || !workType.get().getIsPayrollTarget()) {
                  continue;
              }

              // é‡è¤‡ãƒã‚§ãƒƒã‚¯
              if (workRecordRepository.existsByGoogleEventId(event.getId())) {
                  duplicates++;
                  continue;
              }

              // ç”Ÿå¾’åæŠ½å‡º
              String studentName = extractStudentName(
                  event.getSummary(),
                  workType.get().getCalendarKeyword()
              );

              // WorkRecordä½œæˆ
              WorkRecord record = WorkRecord.builder()
                  .employeeId(employee.getId())
                  .googleEventId(event.getId())
                  .eventTitle(event.getSummary())
                  .startTime(event.getStart().getDateTime())
                  .endTime(event.getEnd().getDateTime())
                  .workTypeId(workType.get().getId())
                  .extractedStudentName(studentName)
                  .syncedAt(Instant.now())
                  .build();

              // Student IDã®è§£æ±ºï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
              studentRepository.findByName(studentName)
                  .ifPresent(student -> record.setStudentId(student.getId()));

              workRecordRepository.save(record);
              newRecords++;
          }

          // åŒæœŸæ™‚åˆ»ã‚’æ›´æ–°
          employee.setLastSyncedAt(Instant.now());
          employeeRepository.save(employee);

          log.info("Synced calendar for employee {}: {} new records, {} duplicates",
                   employee.getId(), newRecords, duplicates);
      }

      private Optional<WorkType> matchWorkType(String eventTitle) {
          List<WorkType> workTypes = workTypeRepository.findAll();

          return workTypes.stream()
              .filter(wt -> eventTitle.startsWith(wt.getCalendarKeyword()))
              .findFirst();
      }

      private String extractStudentName(String eventTitle, String keyword) {
          // "å€‹åˆ¥ï¼ˆå±±ç”°å¤ªéƒï¼‰" â†’ "å±±ç”°å¤ªéƒ"
          String pattern = keyword + "\\s*[ï¼ˆ(](.+?)[)ï¼‰]";
          Pattern regex = Pattern.compile(pattern);
          Matcher matcher = regex.matcher(eventTitle);

          if (matcher.find()) {
              return matcher.group(1).trim();
          }

          return null;
      }
  }

  ---

â— ğŸ“‹ 7. ç·åˆçš„ãªæ”¹å–„ææ¡ˆã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

  7.1. å„ªå…ˆåº¦åˆ¥ã®æ”¹å–„é …ç›®

  ğŸ”´ Criticalï¼ˆå®Ÿè£…å‰ã«å¿…ãšå¯¾å¿œï¼‰

  | é …ç›®                     | ç†ç”±                   | å¯¾å¿œå†…å®¹
            |
  |--------------------------|------------------------|--------------------------------------------
------------|
  | DBè¨­è¨ˆã®è£œå®Œ             | ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€ç›£æŸ»è¦ä»¶ |
created_at/updated_at/ç›£æŸ»ã‚«ãƒ©ãƒ è¿½åŠ ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾© |
  | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®æ˜ç¢ºåŒ– | å€‹äººæƒ…å ±ä¿è­·ã€æ³•ä»¤éµå®ˆ | RBACã€æš—å·åŒ–ã€ç›£æŸ»ãƒ­ã‚°ã®è©³ç´°è¨­è¨ˆ
            |
  | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥   | æœ¬ç•ªé‹ç”¨ã®å®‰å®šæ€§       | å…¨ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—ã¨ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
            |
  | ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†æˆ¦ç•¥         | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯     | JWT/Refresh tokenã®ä¿å­˜ãƒ»å¤±åŠ¹æ–¹æ³•ã®æ±ºå®š
            |
  | ãƒ†ã‚¹ãƒˆæˆ¦ç•¥               | å“è³ªä¿è¨¼               | æœ€ä½é™ã®å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆã®å®šç¾©
            |

  ğŸŸ¡ Highï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ã®å¾ŒåŠã§å¯¾å¿œï¼‰

  | é …ç›®               | ç†ç”±               | å¯¾å¿œå†…å®¹                                   |
  |--------------------|--------------------|--------------------------------------------|
  | ç›£è¦–ãƒ»ãƒ­ã‚°æˆ¦ç•¥     | é‹ç”¨åŠ¹ç‡åŒ–         | Prometheus/Grafanaå°å…¥ã€ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š       |
  | CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³  | é–‹ç™ºåŠ¹ç‡åŒ–         | GitHub Actionsè¨­å®šã€è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ         |
  | APIä»•æ§˜ã®è©³ç´°åŒ–    | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æº | OpenAPI (Swagger) ä»•æ§˜æ›¸ä½œæˆ               |
  | ãƒãƒƒãƒå‡¦ç†ã®å …ç‰¢åŒ– | å®‰å®šé‹ç”¨           | ãƒªãƒˆãƒ©ã‚¤ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€éƒ¨åˆ†å¤±æ•—å¯¾å¿œ |

  ğŸŸ¢ Mediumï¼ˆãƒ•ã‚§ãƒ¼ã‚º2ä»¥é™ã§æ¤œè¨ï¼‰

  | é …ç›®                   | ç†ç”±               | å¯¾å¿œå†…å®¹                          |
  |------------------------|--------------------|-----------------------------------|
  | ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã®å°å…¥     | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š | Rediså°å…¥ã€å˜ä¾¡ãƒã‚¹ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
  | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã®å°å…¥ | ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£   | RabbitMQ/SQSå°å…¥ã€éåŒæœŸå‡¦ç†åŒ–    |
  | ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ     | å°†æ¥ã®æ‹¡å¼µ         | è¤‡æ•°çµ„ç¹”ã§ã®åˆ©ç”¨ã‚’æƒ³å®šã—ãŸè¨­è¨ˆ    |

  ---
  7.2. æ¨å¥¨ã™ã‚‹è¿½åŠ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

  docs/
  â”œâ”€â”€ 01_requirements/
  â”‚   â”œâ”€â”€ REQUIREMENTS_DEFINITION.md  (æ—¢å­˜)
  â”‚   â”œâ”€â”€ SECURITY_REQUIREMENTS.md    (æ–°è¦è¿½åŠ ) â˜…
  â”‚   â””â”€â”€ DATA_RETENTION_POLICY.md    (æ–°è¦è¿½åŠ ) â˜…
  â”œâ”€â”€ 02_architecture_design/
  â”‚   â”œâ”€â”€ ARCHITECTURE_DESIGN.md      (æ—¢å­˜)
  â”‚   â”œâ”€â”€ DATABASE_DESIGN_DETAIL.md   (æ–°è¦è¿½åŠ ) â˜…
  â”‚   â””â”€â”€ SECURITY_ARCHITECTURE.md    (æ–°è¦è¿½åŠ ) â˜…
  â”œâ”€â”€ 03_detailed_design/
  â”‚   â”œâ”€â”€ DETAILED_DESIGN.md          (æ—¢å­˜)
  â”‚   â”œâ”€â”€ API_SPECIFICATION.md        (æ–°è¦è¿½åŠ ) â˜…
  â”‚   â”œâ”€â”€ ERROR_HANDLING.md           (æ–°è¦è¿½åŠ ) â˜…
  â”‚   â””â”€â”€ BATCH_JOB_DESIGN.md         (æ–°è¦è¿½åŠ ) â˜…
  â”œâ”€â”€ 04_operations/                  (æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€) â˜…
  â”‚   â”œâ”€â”€ DEPLOYMENT.md
  â”‚   â”œâ”€â”€ MONITORING.md
  â”‚   â”œâ”€â”€ LOGGING.md
  â”‚   â””â”€â”€ RUNBOOK.md
  â”œâ”€â”€ 05_testing/                     (æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€) â˜…
  â”‚   â”œâ”€â”€ TEST_STRATEGY.md
  â”‚   â”œâ”€â”€ TEST_CASES.md
  â”‚   â””â”€â”€ PERFORMANCE_TEST.md
  â””â”€â”€ 06_development/                 (æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€) â˜…
      â”œâ”€â”€ CODING_STANDARDS.md
      â”œâ”€â”€ GIT_WORKFLOW.md
      â””â”€â”€ LOCAL_DEVELOPMENT.md

  ---
  7.3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å®Œå…¨ç‰ˆææ¡ˆ

  å®Œå…¨ç‰ˆDDL:

  -- ============================================
  -- å¾“æ¥­å“¡ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE employees (
      id SERIAL PRIMARY KEY,
      email VARCHAR(255) UNIQUE NOT NULL,
      name VARCHAR(255) NOT NULL,
      role VARCHAR(20) NOT NULL DEFAULT 'USER' CHECK (role IN ('ADMIN', 'USER')),
      is_active BOOLEAN NOT NULL DEFAULT TRUE,
      google_refresh_token_encrypted TEXT,  -- AES-256-GCMæš—å·åŒ–
      last_synced_at TIMESTAMP,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      created_by INTEGER REFERENCES employees(id),
      updated_by INTEGER REFERENCES employees(id)
  );

  CREATE INDEX idx_employees_email ON employees(email);
  CREATE INDEX idx_employees_active ON employees(is_active);

  -- ============================================
  -- å‹¤å‹™å½¢æ…‹ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE work_types (
      id SERIAL PRIMARY KEY,
      name VARCHAR(100) UNIQUE NOT NULL,
      calendar_keyword VARCHAR(50) UNIQUE NOT NULL,
      is_payroll_target BOOLEAN NOT NULL DEFAULT TRUE,
      rate_type VARCHAR(20) NOT NULL CHECK (rate_type IN ('FIXED', 'STUDENT_LEVEL_BASED')),
      fixed_wage INTEGER CHECK (fixed_wage IS NULL OR fixed_wage > 0),
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      created_by INTEGER REFERENCES employees(id),
      updated_by INTEGER REFERENCES employees(id),
      CONSTRAINT chk_fixed_wage_when_fixed_type
          CHECK (rate_type != 'FIXED' OR fixed_wage IS NOT NULL)
  );

  -- ============================================
  -- å­¦æ ¡ç¨®åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE student_levels (
      id SERIAL PRIMARY KEY,
      level_name VARCHAR(50) UNIQUE NOT NULL,
      display_order INTEGER NOT NULL,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  );

  CREATE UNIQUE INDEX idx_student_levels_order ON student_levels(display_order);

  -- ============================================
  -- ç”Ÿå¾’ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE students (
      id SERIAL PRIMARY KEY,
      name VARCHAR(100) UNIQUE NOT NULL,
      student_level_id INTEGER NOT NULL REFERENCES student_levels(id),
      is_active BOOLEAN NOT NULL DEFAULT TRUE,
      notes TEXT,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      created_by INTEGER REFERENCES employees(id),
      updated_by INTEGER REFERENCES employees(id)
  );

  CREATE INDEX idx_students_name ON students(name);
  CREATE INDEX idx_students_level ON students(student_level_id);
  CREATE INDEX idx_students_active ON students(is_active);

  -- ============================================
  -- æ™‚çµ¦ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE hourly_wages (
      id SERIAL PRIMARY KEY,
      work_type_id INTEGER NOT NULL REFERENCES work_types(id),
      student_level_id INTEGER REFERENCES student_levels(id),
      wage INTEGER NOT NULL CHECK (wage > 0),
      effective_from DATE NOT NULL DEFAULT CURRENT_DATE,
      effective_to DATE,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      created_by INTEGER REFERENCES employees(id),
      updated_by INTEGER REFERENCES employees(id),
      CONSTRAINT chk_effective_period CHECK (effective_to IS NULL OR effective_to >=
effective_from),
      CONSTRAINT uk_wage_combination UNIQUE (work_type_id, student_level_id, effective_from)
  );

  CREATE INDEX idx_hourly_wages_lookup ON hourly_wages(work_type_id, student_level_id);
  CREATE INDEX idx_hourly_wages_effective ON hourly_wages(effective_from, effective_to);

  -- ============================================
  -- å‹¤å‹™è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE work_records (
      id SERIAL PRIMARY KEY,
      employee_id INTEGER NOT NULL REFERENCES employees(id),
      google_event_id VARCHAR(255) UNIQUE NOT NULL,
      event_title VARCHAR(500) NOT NULL,
      start_time TIMESTAMP NOT NULL,
      end_time TIMESTAMP NOT NULL,
      work_type_id INTEGER REFERENCES work_types(id),
      student_id INTEGER REFERENCES students(id),
      extracted_student_name VARCHAR(100),  -- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æŠ½å‡ºã—ãŸç”Ÿå¾’å
      calculated_minutes INTEGER GENERATED ALWAYS AS (
          EXTRACT(EPOCH FROM (end_time - start_time)) / 60
      ) STORED,
      is_paid BOOLEAN NOT NULL DEFAULT FALSE,
      paid_at TIMESTAMP,
      notes TEXT,
      synced_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      CONSTRAINT chk_time_range CHECK (start_time < end_time),
      CONSTRAINT chk_reasonable_duration CHECK (
          EXTRACT(EPOCH FROM (end_time - start_time)) / 3600 <= 12
      )
  );

  CREATE INDEX idx_work_records_employee ON work_records(employee_id);
  CREATE INDEX idx_work_records_employee_time ON work_records(employee_id, start_time);
  CREATE INDEX idx_work_records_google_event ON work_records(google_event_id);
  CREATE INDEX idx_work_records_payment ON work_records(employee_id, is_paid, start_time);
  CREATE INDEX idx_work_records_student ON work_records(student_id);
  CREATE INDEX idx_work_records_work_type ON work_records(work_type_id);

  -- ============================================
  -- çµ¦ä¸è¨ˆç®—å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç›£æŸ»ç”¨ï¼‰
  -- ============================================
  CREATE TABLE payroll_histories (
      id SERIAL PRIMARY KEY,
      employee_id INTEGER NOT NULL REFERENCES employees(id),
      period_start DATE NOT NULL,
      period_end DATE NOT NULL,
      total_work_minutes INTEGER NOT NULL,
      total_payment INTEGER NOT NULL,
      payment_details JSONB NOT NULL,
      calculated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      calculated_by INTEGER NOT NULL REFERENCES employees(id),
      CONSTRAINT chk_period CHECK (period_start <= period_end)
  );

  CREATE INDEX idx_payroll_histories_employee ON payroll_histories(employee_id);
  CREATE INDEX idx_payroll_histories_period ON payroll_histories(period_start, period_end);
  CREATE INDEX idx_payroll_histories_calculated ON payroll_histories(calculated_at);

  -- ============================================
  -- ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE audit_logs (
      id BIGSERIAL PRIMARY KEY,
      table_name VARCHAR(50) NOT NULL,
      record_id INTEGER NOT NULL,
      operation VARCHAR(10) NOT NULL CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
      old_values JSONB,
      new_values JSONB,
      changed_by INTEGER REFERENCES employees(id),
      changed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      ip_address INET,
      user_agent TEXT
  );

  CREATE INDEX idx_audit_logs_table ON audit_logs(table_name, record_id);
  CREATE INDEX idx_audit_logs_user ON audit_logs(changed_by);
  CREATE INDEX idx_audit_logs_time ON audit_logs(changed_at);

  -- ============================================
  -- ãƒãƒƒãƒã‚¸ãƒ§ãƒ–å®Ÿè¡Œå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
  -- ============================================
  CREATE TABLE batch_job_histories (
      id BIGSERIAL PRIMARY KEY,
      job_name VARCHAR(100) NOT NULL,
      started_at TIMESTAMP NOT NULL,
      ended_at TIMESTAMP,
      status VARCHAR(20) NOT NULL CHECK (status IN ('RUNNING', 'SUCCESS', 'FAILURE')),
      success_count INTEGER DEFAULT 0,
      failure_count INTEGER DEFAULT 0,
      error_details JSONB,
      CONSTRAINT chk_job_duration CHECK (ended_at IS NULL OR ended_at >= started_at)
  );

  CREATE INDEX idx_batch_jobs_name ON batch_job_histories(job_name);
  CREATE INDEX idx_batch_jobs_started ON batch_job_histories(started_at);
  CREATE INDEX idx_batch_jobs_status ON batch_job_histories(status);

  -- ============================================
  -- ãƒˆãƒªã‚¬ãƒ¼ï¼šupdated_atã®è‡ªå‹•æ›´æ–°
  -- ============================================
  CREATE OR REPLACE FUNCTION update_updated_at_column()
  RETURNS TRIGGER AS $
  BEGIN
      NEW.updated_at = CURRENT_TIMESTAMP;
      RETURN NEW;
  END;
  $ LANGUAGE plpgsql;

  CREATE TRIGGER update_employees_updated_at BEFORE UPDATE ON employees
      FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

  CREATE TRIGGER update_work_types_updated_at BEFORE UPDATE ON work_types
      FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

  CREATE TRIGGER update_students_updated_at BEFORE UPDATE ON students
      FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

  CREATE TRIGGER update_hourly_wages_updated_at BEFORE UPDATE ON hourly_wages
      FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

  CREATE TRIGGER update_work_records_updated_at BEFORE UPDATE ON work_records
      FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

  ---
  7.4. å®Ÿè£…æ™‚ã®æ¨å¥¨æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°

  # pom.xml æ¨å¥¨ä¾å­˜é–¢ä¿‚

  dependencies:
    # Spring BootåŸºæœ¬
    - spring-boot-starter-web:3.2.x
    - spring-boot-starter-data-jpa:3.2.x
    - spring-boot-starter-security:3.2.x
    - spring-boot-starter-oauth2-client:3.2.x
    - spring-boot-starter-validation:3.2.x
    - spring-boot-starter-actuator:3.2.x

    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    - postgresql:42.7.x
    - flyway-core:10.x

    # Google API
    - google-api-client:2.x
    - google-oauth-client:1.35.x
    - google-api-services-calendar:v3-rev20231123-2.0.0
    - google-api-services-sheets:v4-rev20231101-2.0.0

    # JWT
    - jjwt-api:0.12.x
    - jjwt-impl:0.12.x
    - jjwt-jackson:0.12.x

    # ç›£è¦–ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    - micrometer-registry-prometheus:1.12.x

    # ãƒ­ã‚°
    - logstash-logback-encoder:7.4  # JSONå½¢å¼ãƒ­ã‚°

    # ãƒªãƒˆãƒ©ã‚¤
    - spring-retry:2.0.x

    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ•ã‚§ãƒ¼ã‚º2ï¼‰
    - spring-boot-starter-data-redis:3.2.x

    # ãƒ†ã‚¹ãƒˆ
    - spring-boot-starter-test:3.2.x
    - testcontainers:1.19.x
    - testcontainers-postgresql:1.19.x
    - rest-assured:5.4.x

    # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    - lombok:1.18.x
    - mapstruct:1.5.x

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
    - jasypt-spring-boot-starter:3.0.5  # æš—å·åŒ–

    # API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    - springdoc-openapi-starter-webmvc-ui:2.3.x  # Swagger UI

  ---
  7.5. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ææ¡ˆ

â— æ¨å¥¨ã™ã‚‹é€²ã‚æ–¹ï¼ˆæ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰

  gantt
      title å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
      dateFormat YYYY-MM-DD
      section Phase 0: è¨­è¨ˆè£œå®Œ
      è¨­è¨ˆæ›¸ã®æ›´æ–°ï¼ˆCriticalé …ç›®ï¼‰       :crit, 2025-12-30, 7d
      ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆæ›¸ä½œæˆ             :crit, 2025-12-30, 5d
      DBè©³ç´°è¨­è¨ˆæ›¸ä½œæˆ                   :crit, 2026-01-02, 5d
      ãƒ†ã‚¹ãƒˆæˆ¦ç•¥æ›¸ä½œæˆ                   :crit, 2026-01-04, 3d

      section Phase 1: åŸºç›¤å®Ÿè£…
      ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—           :2026-01-08, 3d
      DBæ§‹ç¯‰ï¼ˆFlyway migrationï¼‰         :2026-01-11, 5d
      èªè¨¼åŸºç›¤å®Ÿè£…ï¼ˆOAuth + JWTï¼‰        :2026-01-16, 7d
      åŸºæœ¬CRUD APIå®Ÿè£…                   :2026-01-23, 10d

      section Phase 2: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…
      Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº               :2026-02-02, 7d
      Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº         :2026-02-09, 5d
      çµ¦ä¸è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…               :2026-02-14, 10d
      ãƒãƒƒãƒå‡¦ç†å®Ÿè£…                     :2026-02-24, 7d

      section Phase 3: å“è³ªä¿è¨¼
      å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè£…                     :2026-03-03, 10d
      çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè£…                     :2026-03-13, 7d
      æ€§èƒ½ãƒ†ã‚¹ãƒˆå®Ÿæ–½                     :2026-03-20, 5d
      ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆå®Ÿæ–½             :2026-03-25, 5d

      section Phase 4: æœ¬ç•ªåŒ–æº–å‚™
      ç›£è¦–ãƒ»ãƒ­ã‚°åŸºç›¤æ§‹ç¯‰                 :2026-03-30, 5d
      CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰              :2026-04-04, 5d
      é‹ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™               :2026-04-09, 5d
      æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰                       :2026-04-14, 5d
      æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹                       :milestone, 2026-04-19, 0d

  ---
  ğŸ¯ ã¾ã¨ã‚

  ç¾åœ¨ã®è¨­è¨ˆã®å„ªã‚ŒãŸç‚¹

  1. âœ… æ˜ç¢ºãªã‚¹ã‚³ãƒ¼ãƒ—å®šç¾©: ãƒ•ã‚§ãƒ¼ã‚ºåˆ†ã‘ãŒé©åˆ‡ã§ã€æ®µéšçš„ãªæ‹¡å¼µãŒå¯èƒ½
  2. âœ… å¦¥å½“ãªæŠ€è¡“é¸å®š: Spring Bootã€PostgreSQLã¯å®Ÿç¸¾ãŒã‚ã‚Šé©åˆ‡
  3. âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŸºæœ¬æ§‹é€ ã¯è‰¯å¥½
  4. âœ… è¦ä»¶ã®IDç®¡ç†: ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹

  Critical ãªæ”¹å–„å¿…é ˆé …ç›®ï¼ˆå®Ÿè£…å‰ã«å¯¾å¿œï¼‰

  1. ğŸ”´ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®å®Œå…¨åŒ–:
    - ç›£æŸ»ã‚«ãƒ©ãƒ ï¼ˆcreated_at, updated_at, created_by, updated_byï¼‰ã®è¿½åŠ 
    - å¿…é ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å®šç¾©
    - åˆ¶ç´„æ¡ä»¶ã®æ˜ç¤º
  2. ğŸ”´ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®è©³ç´°åŒ–:
    - RBACï¼ˆãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰ã®å®Ÿè£…
    - ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†æˆ¦ç•¥ï¼ˆJWTä¿å­˜ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã€å¤±åŠ¹ï¼‰
    - ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ï¼ˆat restï¼‰
  3. ğŸ”´ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥:
    - ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—
    - æ¨™æº–åŒ–ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    - ãƒªãƒˆãƒ©ã‚¤ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥
  4. ğŸ”´ ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ç­–å®š:
    - å˜ä½“ãƒ»çµ±åˆãƒ»E2Eãƒ†ã‚¹ãƒˆã®å®šç¾©
    - ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ã®è¨­å®š
  5. ğŸ”´ ç›£æŸ»ãƒ»ãƒ­ã‚°è¦ä»¶ã®æ˜ç¢ºåŒ–:
    - ç›£æŸ»ãƒ­ã‚°ã®è¨˜éŒ²å¯¾è±¡ã¨ä¿æŒæœŸé–“
    - æ§‹é€ åŒ–ãƒ­ã‚°ã®å½¢å¼
    - å€‹äººæƒ…å ±ã®ãƒã‚¹ã‚­ãƒ³ã‚°