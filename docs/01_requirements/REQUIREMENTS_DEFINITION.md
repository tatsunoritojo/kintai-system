# 要件定義書

- バージョン: 2.0
- 作成日: 2025年12月29日
- 最終更新日: 2025年12月30日
- 作成者: Project Manager

---

## 1. 概要

### 1.1. プロジェクトの背景
現在、手作業またはスプレッドシート等で行われている時給ベースの給与計算は、手間がかかり、計算ミスが発生するリスクを抱えている。特に、勤務時間がGoogleカレンダーで管理されている場合、そのデータを手動で転記するプロセスは非効率である。

### 1.2. プロジェクトの目標
本プロジェクトの目標は、Googleカレンダーの予定情報と連携し、従業員の給与計算を自動化するバックエンドシステムを構築することである。これにより、給与計算プロセスの効率化、正確性の向上、および管理コストの削減を実現する。

## 2. スコープ

### 2.1. 対象範囲（In-Scope）
- **ユーザー認証:** Googleアカウント（OAuth 2.0）を利用したユーザー認証機能。
- **Googleカレンダー連携:** 認証されたユーザーのGoogleカレンダーから、勤務形態に紐づくキーワードを含む予定を取得する機能。
- **Googleスプレッドシート連携:** 利用者（生徒）情報が記載されたGoogleスプレッドシートを定期的に読み込み、システム内に同期する機能。
- **勤務記録:** 取得した予定から勤務開始・終了時刻等を抽出し、システム内のデータベースに記録する機能。重複登録は防止する。
- **データ管理API:** 以下の情報を、ページネーション・ソート機能付きで管理（CRUD）するためのRESTful APIを提供する。
    - 従業員情報
    - 勤務形態（給与計算対象かどうかのフラグも含む）
    - 単価情報（勤務形態や生徒の学校種別に応じた動的な単価設定）
    - 生徒情報（スプレッドシートからの同期データ）
- **動的給与計算:** 登録された勤務記録、勤務形態、単価情報、生徒情報を基に、指定された期間の給与を動的に計算する機能。
- **給与レポート出力API:** 計算結果を指定されたフォーマット（JSON）で出力するAPIを提供する。
- **手動同期API:** 管理者が任意のタイミングで特定の従業員のデータ同期をトリガーするAPIを提供する。

### 2.2. 対象範囲外（Out-of-Scope）
- **管理用GUI:** 本プロジェクト（フェーズ1）では、各種情報を管理するためのグラフィカル・ユーザーインターフェース（GUI）は構築しない。API経由での操作を前提とする。（フェーズ2以降で検討）
- **税金・社会保険料計算:** 源泉徴収税や社会保険料などの複雑な計算は範囲外とする。
- **有給休暇・各種手当管理:** 有給休暇の管理や、交通費などの各種手当の計算は範囲外とする。

## 3. 機能要件

| ID | 要件名 | 詳細 |
| :--- | :--- | :--- |
| **FR-001** | ユーザー認証 | ユーザーはGoogleアカウントを用いてシステムにログインし、APIアクセスに必要な認可を得る。 |
| **FR-002** | データ同期（自動） | システムは毎時0分に、全アクティブ従業員のGoogleカレンダーおよび指定されたGoogleスプレッドシートを自動で同期し、勤務記録と生徒情報をDBに保存する。重複登録は`google_event_id`によるユニーク制約で防止する。 |
| **FR-003** | データ同期（手動） | 管理者はAPI経由で、特定の従業員のGoogleカレンダーデータの手動同期を任意のタイミングで実行できる。 |
| **FR-004** | 動的給与計算 | APIリクエストに基づき、指定された従業員と期間の給与を計算する。勤務形態、生徒情報（スプレッドシート由来）に応じた動的な単価を適用する。最大拘束6時間のため、休憩時間の自動控除は行わない。|
| **FR-005** | CRUD API | 従業員、勤務形態、単価、生徒などのマスタデータを管理するためのRESTful APIを提供する。すべての一覧取得APIはページネーションとソート機能を備える。|
| **FR-006** | 給与レポートAPI | 指定した従業員・期間の給与計算結果をJSON形式で返す `/api/payrolls` エンドポイントを提供する。 |
| **FR-007** | アクセス制御 | 管理者(ADMIN)と一般ユーザー(USER)の2つのロールを設け、管理者のみがマスタデータの変更、他ユーザーの給与計算、手動同期を実行できる。一般ユーザーは自分の給与情報のみ閲覧可能。 |
| **FR-008** | 監査ログ | すべてのデータ変更操作（作成・更新・削除）、給与計算実行について、実行者・実行日時を記録する。 |
| **FR-009** | エラーハンドリング | すべてのAPIエンドポイントは、標準化されたエラーレスポンス（RFC 7807準拠）を返す。Google API障害時は適切なリトライ処理を行う。 |

## 4. 非機能要件

| ID | 要件名 | 詳細 |
| :--- | :--- | :--- |
| **NFR-001** | セキュリティ（暗号化） | すべての通信はTLS 1.2以上で暗号化する。データベース内の個人情報（email）およびGoogleリフレッシュトークンはAES-256-GCMで暗号化して保存する。 |
| **NFR-002** | セキュリティ（認証・認可） | OAuth 2.0 Authorization Code Flow with PKCEを使用。JWT署名はRS256を使用（HS256不可）。リフレッシュトークンローテーションを実装する。APIレート制限は認証済みユーザー100req/min、未認証10req/minとする。 |
| **NFR-003** | パフォーマンス | 各APIの平均レスポンスタイムは500ms以内、P95で1秒以内を目標とする。給与計算APIは最大5秒以内に応答する。バッチ処理は最大50分以内に完了する。 |
| **NFR-004** | 可用性 | システム稼働率99.5%を目標とする。Google API障害時は指数バックオフで最大3回リトライする。部分的な障害時も可能な範囲で縮退運転を行う。 |
| **NFR-005** | 拡張性・保守性 | 将来のGUI追加や計算ロジック変更に備え、バックエンドとフロントエンドが分離可能な構成とする。データベース設計は正規化を意識し、変更容易性を確保する。すべてのテーブルに監査カラム（created_at, updated_at, created_by, updated_by）を設ける。 |
| **NFR-006** | データ保持 | 勤務記録・給与計算履歴は最低5年間保持する。監査ログは5年間保持する。バックアップは毎日取得し、30日間保持する。 |
| **NFR-007** | 監視・ログ | すべてのエラーログにはトレースIDを付与し、分散トレーシングを可能にする。個人情報はログ出力時にマスキングする。ログはJSON形式の構造化ログとし、HOT期間90日、COLD期間5年保存する。 |
| **NFR-008** | 技術スタック | バックエンドはJava 17、WebフレームワークとしてSpring Boot 3.2.xを採用する。データベースは開発・本番ともにPostgreSQL 15.x以上をDockerで稼働させる。データベースマイグレーションにはFlywayを使用する。 |

## 5. 将来の展望
- **フェーズ2:** 管理者向けのWebベースGUIを開発し、APIと連携させる。
- **フェーズ3:** 計算ロジックを拡張し、残業代や深夜手当などの計算に対応する。
- **フェーズ4:** 会計ソフトなど、外部システムとの連携機能を開発する。

